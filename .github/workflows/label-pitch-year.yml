name: Label Pitch Year
on:
  issues:
    types: [opened]
jobs:
  compile-form:
    if: >
      ! contains(join(github.event.issue.labels.*.name, ', '), 'year/') &&
      contains(github.event.issue.labels.*.name, 'pitch')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Parse issue
        id: parse
        uses: onmax/issue-form-parser@v1.4
        with:
          issue_number: ${{ github.event.issue.number }}
      - name: Get project year
        uses: mikefarah/yq@master
        with:
          cmd: >
            echo "YEAR=$(yq '.event.year' config.yaml)" >> "$GITHUB_ENV"
      - name: Set year label
        uses: actions/github-script@v6
        with:
            script: |
                github.rest.issues.addLabels({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    labels: [`year/${process.env.YEAR}}`]
                })